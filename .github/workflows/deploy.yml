name: ğŸš€ DÃ©ploiement du DÃ©tecteur de MÃ©lanome

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'README.md'
      - 'Notebook/**'
      - 'data/**'
      - 'images_test/**'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ” Debug avant SSH
      run: |
        echo "ğŸ’¡ DÃ©but du dÃ©ploiement du DÃ©tecteur de MÃ©lanome"
        echo "ğŸ—ï¸ SystÃ¨me d'exploitation:"
        uname -a
        echo "ğŸ“‚ Contenu du rÃ©pertoire:"
        ls -lah

    - name: ğŸ”‘ Configuration SSH
      run: |
        set -x
        echo "ğŸ”§ Configuration de l'environnement SSH..."
        mkdir -p ~/.ssh
        echo "${{ secrets.AWS_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        
        # Configuration du known_hosts
        ssh-keyscan -H ${{ secrets.AWS_HOST }} >> ~/.ssh/known_hosts
        
        # Test de connexion
        ssh -i ~/.ssh/id_rsa ubuntu@${{ secrets.AWS_HOST }} "echo 'âœ… Connexion SSH rÃ©ussie'"

    - name: ğŸ—‘ï¸ Nettoyage du rÃ©pertoire distant
      run: |
        ssh -i ~/.ssh/id_rsa ubuntu@${{ secrets.AWS_HOST }} "
          echo 'ğŸ§¹ Nettoyage du rÃ©pertoire de dÃ©ploiement...'
          sudo rm -rf /home/ubuntu/melanoma-detection/*
        "

    - name: ğŸ“‚ Transfert des fichiers
      run: |
        echo "ğŸš€ DÃ©but du transfert des fichiers vers AWS..."
        rsync -avz \
          --exclude='.git' \
          --exclude='.github' \
          --exclude='.gitignore' \
          --exclude='.env' \
          --exclude='__pycache__' \
          --exclude='*.pyc' \
          -e "ssh -i ~/.ssh/id_rsa" \
          . ubuntu@${{ secrets.AWS_HOST }}:/home/ubuntu/melanoma-detection
        echo "âœ… Transfert terminÃ© !"

    - name: ğŸš€ DÃ©ploiement sur AWS
      run: |
        ssh -i ~/.ssh/id_rsa ubuntu@${{ secrets.AWS_HOST }} << 'EOF'
        set -e
        echo "ğŸ”„ Mise Ã  jour du systÃ¨me..."
        sudo apt update -y

        # Installation de Docker
        if ! command -v docker &> /dev/null; then
            echo "ğŸ³ Installation de Docker..."
            sudo apt install -y docker.io
            sudo systemctl enable docker
            sudo systemctl start docker
        fi

        # Installation de Docker Compose
        if ! command -v docker-compose &> /dev/null; then
            echo "ğŸ“¦ Installation de Docker Compose..."
            sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
        fi

        # Configuration des permissions
        sudo usermod -aG docker ubuntu
        newgrp docker

        # DÃ©ploiement
        echo "ğŸš€ DÃ©marrage du dÃ©ploiement..."
        cd /home/ubuntu/melanoma-detection
        
        # ArrÃªt des conteneurs existants
        docker-compose down || true
        
        # Nettoyage des ressources Docker inutilisÃ©es
        docker system prune -f
        
        # DÃ©marrage des services
        docker-compose up --build -d
        
        # VÃ©rification des conteneurs
        echo "ğŸ“Š Ã‰tat des conteneurs :"
        docker ps -a
        echo "âœ… DÃ©ploiement terminÃ© !"
        EOF

    - name: ğŸ§¹ Nettoyage
      run: |
        echo "ğŸ§¹ Nettoyage des clÃ©s SSH..."
        rm -rf ~/.ssh
        echo "âœ… Nettoyage terminÃ© !"